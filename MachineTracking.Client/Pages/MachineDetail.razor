@page "/machinedetail/{MachineId}"
@using MachineTracking.Client.Shared.Helpers
@using MachineTracking.Client.Shared.Helpers.Interfaces
@using MachineTracking.Domain.DTOs
@using MachineTracking.Domain.Enums
@using MudBlazor
@using System.Text.Json;
@inject SignalRService SignalRService
@inject IHttpClientProvider HttpClientProvider
@using MachineTracking.Client.Components.MachineHistory

<MudContainer Class="mud-container-max-width" MaxWidth="MaxWidth.Large" Style="padding: 16px;">
    <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true" Style="font-weight: bold; color: #2C3E50;">
        📜 Past Activity of Machine @MachineId
    </MudText>
    <MudCard Class="mud-elevation-4" Style="padding: 16px;">

        <MudTextField Label="Search"
                      Variant="Variant.Text"
                      @bind-Value="searchText"
                      Immediate="true"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      OnAdornmentClick="HandleSearchOnAdornmentIcon" />

        <MudTable Items="machineData.Values" Bordered="true" Hover="true" Striped="true" Breakpoint="Breakpoint.Sm" TotalItems="totalItems">
            <HeaderContent>
                <MudTh>Machine ID</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Chain Moves/Second</MudTh>
                <MudTh>Article Number</MudTh>
                <MudTh>Timestamp</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Machine ID">@context.MachineId</MudTd>
                <MudTd DataLabel="Status">
                    @if (@context.StatusId == (int)MachineStatusTypeEnum.Active)
                    {
                        <MudChip T="string" Color="Color.Success" Style="margin: 0;">Active</MudChip>
                    }
                    else if (@context.StatusId == (int)MachineStatusTypeEnum.Inactive)
                    {
                        <MudChip T="string" Color="Color.Default" Style="margin: 0;">Inactive</MudChip>
                    }
                    else if (@context.StatusId == (int)MachineStatusTypeEnum.Idle)
                    {
                        <MudChip T="string" Color="Color.Warning" Style="margin: 0;">Idle</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Error" Style="margin: 0;">Unexpected</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Chain Moves/Second">@context.ChainMovesPerSecond</MudTd>
                <MudTd DataLabel="Article Number">@context.ArticleNumber</MudTd>
                <MudTd DataLabel="Timestamp">
                    <MudTooltip Text="Data received timestamp">@context.DataReceivedTimestamp</MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudCard>
    <MudCard Class="mud-elevation-4" Style="padding: 16px;">
        <MudGrid Justify="Justify.Center">
            <MudItem xs="12" sm="12" md="12">
                <MudPagination Color="Color.Primary" Count="GetTotalPages()" SelectedChanged="HandlePagination" />
            </MudItem>
        </MudGrid>
    </MudCard>
</MudContainer>

@if (machineData.Values.Any() == true)
{
    <ChainMovesLineChart MachineData="machineData" />
}

@code {
    [Parameter]
    public string MachineId { get; set; }

    private MachineHistoryPaginatedResponse data = new();
    private IDictionary<DateTime, MachineHistoryDTO> machineData = new Dictionary<DateTime, MachineHistoryDTO>();
    private string getMachineHistoriesEndpoint = "api/MachineHistory/GetMachineHistoriesAsync";
    private string searchText = "";
    private int totalItems = 25;
    private int pageNumber = 1;
    private int pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        data = await GetMachineHistoriesAsync();

        SignalRService.OnMachineDataReceived += OnMachineDataReceived;
        await SignalRService.StartAsync();
    }

    private void OnMachineDataReceived(string data)
    {
        var newData = JsonSerializer.Deserialize<MachineHistoryDTO>(data);
        if (newData != null)
        {
            newData.StatusId = MapStatusToStatusId(newData);
            machineData.Add(newData.DataReceivedTimestamp, newData);
            machineData = machineData.OrderByDescending(obd => obd.Key).ToDictionary();
        }

        InvokeAsync(StateHasChanged);
    }

    private async Task<MachineHistoryPaginatedResponse> GetMachineHistoriesAsync()
    {
        var response = await HttpClientProvider.RequestGetByObject(getMachineHistoriesEndpoint, new MachineHistoryGetRequestDTO()
            {
                MachineId = MachineId,
                PageNumber = pageNumber,
                PageSize = pageSize,
                SearchText = searchText
            });

        if (response.IsSuccessStatusCode)
        {
            data = await response.Content.ReadFromJsonAsync<MachineHistoryPaginatedResponse>() ?? new MachineHistoryPaginatedResponse();
            totalItems = data.TotalCount;
            machineData = data.MachineHistories.ToDictionary(item => item.DataReceivedTimestamp, item => item);
        }

        return data;
    }

    private async Task HandleSearchOnAdornmentIcon()
    {
        pageNumber = 1;
        data = await GetMachineHistoriesAsync();
        await HandlePagination(pageNumber);
    }

    private int GetTotalPages()
    {
        var totalPages = (double)data.TotalCount / (double)pageSize;

        return Convert.ToInt32(Math.Ceiling(totalPages));
    }

    private async Task HandlePagination(int page)
    {
        pageNumber = page;
        data = await GetMachineHistoriesAsync();
    }

    private int MapStatusToStatusId(MachineHistoryDTO machineHistory)
    {
        return machineHistory.Status switch
        {
            "EngineOn" when machineHistory.ChainMovesPerSecond > 0 => (int)MachineStatusTypeEnum.Active,
            "EngineOn" when machineHistory.ChainMovesPerSecond == 0 => (int)MachineStatusTypeEnum.Idle,
            "EngineOff" when machineHistory.ChainMovesPerSecond <= 0 => (int)MachineStatusTypeEnum.Inactive,
            _ => (int)MachineStatusTypeEnum.Unexpected
        };
    }
}
